<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>แจ้งปัญหา | สภานักเรียน NBY</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --accent: #38bdf8;
            --danger: #ff4d4d;
            --warning: #fbbf24;
            --success: #22c55e;
            --grey: #94a3b8;
            --border: rgba(255, 255, 255, 0.15);
            --glass-dark: rgba(15, 23, 42, 0.75);
            --glass-input: rgba(255, 255, 255, 0.05);
            --curve: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body { color: white; font-family: 'Sarabun', sans-serif; background: #020617; margin: 0; overflow-x: hidden; }
        .container { max-width: 600px; padding-top: 80px; padding-bottom: 80px; }

        @keyframes floatIn {
            from { opacity: 0; transform: translateY(30px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .main-title {
            font-family: 'Kanit'; font-weight: 700; font-size: 2.5rem;
            background: linear-gradient(to bottom, #fff, var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: floatIn 0.8s var(--curve);
        }

        .glass-card {
            background: var(--glass-dark);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border);
            border-radius: 30px; padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            margin-bottom: 40px;
            animation: floatIn 1s var(--curve) backwards;
        }

        .custom-textarea, .custom-input {
            background: var(--glass-input);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px; color: white; padding: 18px; width: 100%;
            font-size: 1rem; transition: 0.4s; 
        }
        .custom-textarea { resize: none; }
        .custom-input { border-radius: 15px; padding: 12px 18px; }
        .custom-textarea:focus, .custom-input:focus { border-color: var(--accent); outline: none; background: rgba(255,255,255,0.1); transform: translateY(-2px); }

        .btn-submit {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            color: white; border: 1px solid var(--border); border-radius: 16px;
            padding: 15px; font-family: 'Kanit'; font-weight: 700; width: 100%;
            margin-top: 20px; transition: 0.4s var(--curve); cursor: pointer;
        }
        .btn-submit:hover { transform: scale(1.02) translateY(-3px); background: rgba(56, 189, 248, 0.2); border-color: var(--accent); }

        .complaint-item { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--border); 
            border-radius: 25px; padding: 22px; margin-bottom: 18px; 
            transition: 0.4s var(--curve); animation: floatIn 0.6s var(--curve) backwards;
        }
        .badge-status { padding: 5px 12px; border-radius: 10px; font-family: 'Kanit'; font-weight: 700; font-size: 0.75rem; margin-bottom: 12px; display: inline-block; }
        .status-wait { color: var(--grey); border: 1px solid var(--grey); }
        .status-fail { color: var(--danger); border: 1px solid var(--danger); text-shadow: 0 0 10px rgba(255,77,77,0.4); }
        .status-process { color: var(--warning); border: 1px solid var(--warning); text-shadow: 0 0 10px rgba(251,191,36,0.4); }
        .status-success { color: var(--success); border: 1px solid var(--success); text-shadow: 0 0 10px rgba(34,197,94,0.4); }

        .ref-link { color: var(--accent); text-decoration: none; font-size: 0.9rem; word-break: break-all; }
        .ref-link:hover { text-decoration: underline; }

        .stellar-overlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.9); display: none; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(20px); }
        .alert-box { text-align: center; padding: 40px; border-radius: 40px; max-width: 350px; width: 85%; transform: scale(0.5); opacity: 0; transition: 0.6s var(--curve); border: 1px solid rgba(255,255,255,0.1); }
        .show .alert-box { transform: scale(1); opacity: 1; }
        .alert-icon-anim { font-size: 70px; margin-bottom: 20px; animation: rotateIn 0.8s var(--curve) forwards; }
        @keyframes rotateIn { from { transform: scale(0) rotate(-180deg); } to { transform: scale(1) rotate(0deg); } }
    </style>
</head>
<body>
    <script src="All/กำลังโหลด.js"></script>
    <script src="All/ย้อนกลับ.js"></script>
    <script src="All/พื้นหลัง.js"></script>

    <div id="stellarOverlay" class="stellar-overlay">
        <div id="alertContent" class="alert-box shadow-lg">
            <div id="alertIcon" class="alert-icon-anim"></div>
            <h3 id="alertTitle" style="font-family: 'Kanit'; font-weight: 700;"></h3>
            <p id="alertDesc" style="font-size: 1rem; opacity: 0.7; margin: 0;"></p>
            <button class="btn btn-info rounded-pill px-5 mt-4 fw-bold" onclick="closeOverlay()">ตกลง</button>
        </div>
    </div>

    <div class="container">
        <div class="text-center mb-5">
            <h1 class="main-title">ศูนย์แจ้งปัญหา</h1>
            <p style="opacity: 0.5; font-size: 0.8rem; letter-spacing: 4px;">STELLAR COUNCIL</p>
        </div>

        <div class="glass-card">
            <p class="mb-2" style="font-family: 'Kanit'; font-weight: 600; color: var(--accent);">
                <i class="fas fa-edit me-2"></i>รายละเอียดความต้องการ
            </p>
            <textarea id="detail" rows="4" class="custom-textarea" placeholder="ระบุปัญหาอย่างละเอียด..."></textarea>
            
            <p class="mb-2 mt-4" style="font-family: 'Kanit'; font-weight: 600; color: var(--accent);">
                <i class="fas fa-link me-2"></i>ลิงก์อ้างอิง (ถ้ามี)
            </p>
            <input type="url" id="refLink" class="custom-input" placeholder="https://example.com">

            <button id="btnSubmit" class="btn-submit">
                <i class="fas fa-paper-plane me-2"></i>ส่งข้อมูล
            </button>
        </div>

        <div class="d-flex align-items-center mb-4 px-2">
            <span style="font-family: 'Kanit'; font-size: 1rem; font-weight: 600; color: rgba(255,255,255,0.7);">รายการแจ้งล่าสุด</span>
            <div class="ms-3 flex-grow-1 border-bottom border-secondary opacity-20"></div>
        </div>

        <div id="complaintList"></div>
    </div>

    <script type="module">
        // นำเข้า DatabaseAPI จากไฟล์แยก
        import { DatabaseAPI } from './All/ฐานข้อมูล.js';

        const badWords = ["ควย", "เย็ด", "มึง", "กู", "สัส", "เหี้ย", "ดอกทอง", "ชิบหาย", "อีดอก"];
        const btnSubmit = document.getElementById('btnSubmit');
        const detailInput = document.getElementById('detail');
        const refLinkInput = document.getElementById('refLink');
        const complaintList = document.getElementById('complaintList');
        const overlay = document.getElementById('stellarOverlay');

        window.showAlert = (type, title, desc) => {
            const content = document.getElementById('alertContent');
            const icon = document.getElementById('alertIcon');
            content.style.background = type === 'success' ? 'rgba(15, 23, 42, 0.9)' : 'rgba(40, 10, 10, 0.9)';
            content.style.borderColor = type === 'success' ? 'var(--accent)' : 'var(--danger)';
            icon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle" style="color: var(--accent);"></i>' : '<i class="fas fa-exclamation-circle" style="color: var(--danger);"></i>';
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertTitle').style.color = type === 'success' ? 'var(--accent)' : 'var(--danger)';
            document.getElementById('alertDesc').innerText = desc;
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show'), 10);
        };

        window.closeOverlay = () => {
            overlay.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 400);
        };

        // การส่งข้อมูลผ่าน API
        btnSubmit.addEventListener('click', async () => {
            const detail = detailInput.value.trim();
            const refLink = refLinkInput.value.trim();
            
            if(!detail) return;
            
            if(badWords.some(word => detail.includes(word))) {
                showAlert('warning', 'คำไม่สุภาพ!', 'ขอความกรุณาใช้ถ้อยคำที่สุภาพในการแจ้งเรื่องครับ');
                return;
            }
            
            btnSubmit.disabled = true;
            try {
                // เรียกใช้ API จากไฟล์ ฐานข้อมูล.js (ส่ง detail และ refLink)
                await DatabaseAPI.submitComplaint(detail, refLink);
                
                detailInput.value = "";
                refLinkInput.value = "";
                showAlert('success', 'ส่งเรื่องสำเร็จ!', 'ข้อมูลของคุณถูกส่งไปยังสภานักเรียนแล้ว');
            } catch (e) { 
                console.error(e);
                showAlert('danger', 'เกิดข้อผิดพลาด', 'ไม่สามารถส่งข้อมูลได้ในขณะนี้');
            }
            finally { btnSubmit.disabled = false; }
        });

        // ติดตามข้อมูล Real-time ผ่าน API
        DatabaseAPI.listenToComplaints((snapshot) => {
            complaintList.innerHTML = "";
            const now = new Date();
            const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;

            snapshot.forEach((doc, index) => {
                const data = doc.data();
                const status = data.status || "ยังไม่ได้แก้ไข";
                
                if (data.timestamp && (status === "แก้ไขแล้ว" || status === "ไม่สามารถแก้ไขได้")) {
                    const postDate = data.timestamp.toDate();
                    if (now - postDate > sevenDaysInMs) return; 
                }

                let sClass = "status-wait";
                if(status === "กำลังดำเนินการ") sClass = "status-process";
                if(status === "แก้ไขแล้ว") sClass = "status-success";
                if(status === "ไม่สามารถแก้ไขได้") sClass = "status-fail";

                const item = document.createElement('div');
                item.className = 'complaint-item';
                item.style.animationDelay = `${index * 0.05}s`;
                
                // ตรวจสอบว่ามีลิงก์อ้างอิงหรือไม่
                const refLinkHtml = data.refLink ? `
                    <div style="margin-top: 10px;">
                        <small style="opacity: 0.6;"><i class="fas fa-link me-1"></i>อ้างอิง:</small>
                        <a href="${data.refLink}" target="_blank" class="ref-link">${data.refLink}</a>
                    </div>
                ` : "";

                item.innerHTML = `
                    <span class="badge-status ${sClass}">${status}</span>
                    <div style="font-size: 1rem; line-height: 1.6; color: #f1f5f9;">${data.detail}</div>
                    ${refLinkHtml}
                    ${data.adminReply ? `<div style="background: rgba(56,189,248,0.1); border-left: 4px solid var(--accent); padding: 12px; border-radius: 12px; margin-top: 15px; font-size: 0.9rem;">
                        <b style="color: var(--accent);"><i class="fas fa-reply me-1"></i>สภานักเรียน:</b> ${data.adminReply}
                    </div>` : ""}
                    <div style="font-size: 0.75rem; opacity: 0.4; margin-top: 15px;">
                        <i class="far fa-calendar-alt me-1"></i> ${data.timestamp ? data.timestamp.toDate().toLocaleString('th-TH') : 'กำลังส่ง...'}
                    </div>
                `;
                complaintList.appendChild(item);
            });
        });
    </script>
</body>
</html>

