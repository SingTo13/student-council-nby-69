<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แจ้งปัญหา | Stellar Council NBY</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #030712;
            --accent: #38bdf8;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.12);
            --glow: rgba(56, 189, 248, 0.4);
        }

        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Sarabun', sans-serif;
            min-height: 100vh;
            background: radial-gradient(circle at 50% 0%, #111827 0%, #030712 100%);
            overflow-x: hidden;
        }

        /* Star Effect */
        #stars-container { position: fixed; inset: 0; z-index: -1; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0; animation: twinkle 3s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0; } 50% { opacity: 0.7; } }

        .nav-btn {
            position: absolute; top: 30px; left: 30px;
            padding: 10px 20px; border-radius: 12px;
            background: var(--glass); border: 1px solid var(--border);
            color: white; text-decoration: none; backdrop-filter: blur(10px);
            transition: 0.3s; z-index: 100;
        }
        .nav-btn:hover { background: white; color: black; }

        .main-container { padding-top: 100px; padding-bottom: 50px; max-width: 800px; }

        .header-title {
            font-family: 'Kanit'; font-weight: 700; font-size: 2.8rem;
            background: linear-gradient(to bottom, #fff 40%, var(--accent));
            background-clip: text; -webkit-background-clip: text;
            color: transparent; -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        /* Form Style */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            margin-bottom: 50px;
        }

        .form-label { font-family: 'Kanit'; font-weight: 400; font-size: 1.1rem; color: var(--accent); margin-bottom: 15px; }

        .custom-textarea {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 18px;
            color: white; padding: 20px; font-size: 1.1rem;
            transition: 0.3s; width: 100%;
        }
        .custom-textarea:focus {
            background: rgba(255, 255, 255, 0.07);
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--glow);
            outline: none; color: white;
        }

        .btn-send {
            background: white; color: #030712;
            border: none; border-radius: 15px;
            padding: 15px 30px; font-family: 'Kanit'; font-weight: 600;
            width: 100%; margin-top: 20px; transition: 0.4s;
        }
        .btn-send:hover { transform: translateY(-3px); box-shadow: 0 10px 25px var(--glow); opacity: 0.9; }

        /* Status Badges */
        .status-badge {
            padding: 5px 12px; border-radius: 8px; font-size: 0.75rem; 
            font-family: 'Kanit'; font-weight: 600; display: inline-block; margin-bottom: 10px;
        }
        .status-none { background: #ef4444; color: white; } /* ยังไม่ได้แก้ไข */
        .status-doing { background: #f59e0b; color: white; } /* กำลังดำเนินการ */
        .status-done { background: #10b981; color: white; } /* แก้ไขแล้ว */
        .status-cancel { background: #6b7280; color: white; } /* ไม่สามารถทำได้ */

        /* Complaint Cards */
        .complaint-item {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            transition: 0.3s;
        }
        .complaint-item:hover { transform: scale(1.02); border-color: var(--accent); }
        .complaint-text { font-size: 1.05rem; line-height: 1.6; color: #e2e8f0; }
        .complaint-meta { font-size: 0.8rem; color: #94a3b8; margin-top: 15px; display: flex; justify-content: space-between; }

    </style>
</head>
<body>

    <div id="stars-container"></div>

    <a href="index.html" class="nav-btn"><i class="fas fa-chevron-left me-2"></i>กลับหน้าหลัก</a>

    <div class="container main-container">
        <div class="text-center mb-5">
            <h1 class="header-title">Report Center</h1>
            <p class="opacity-50 text-uppercase" style="letter-spacing: 3px; font-size: 0.8rem;">ระบบรับเรื่องร้องเรียนออนไลน์</p>
        </div>

        <div class="glass-panel">
            <div class="mb-3">
                <label class="form-label">ปัญหาที่ท่านพบ (โปรดอธิบายโดยละเอียดเพื่อให้แก้ไขได้ถูกจุด)</label>
                <textarea id="detail" rows="5" class="custom-textarea" placeholder="ระบุรายละเอียดปัญหา เช่น บริเวณที่เกิดเหตุ วันเวลา หรือลักษณะปัญหา..."></textarea>
            </div>
            <button id="btnSubmit" class="btn-send">
                <i class="fas fa-paper-plane me-2"></i>ส่งข้อมูลให้สภานักเรียน
            </button>
        </div>

        <div class="px-2">
            <h3 class="mb-4" style="font-family: 'Kanit'; font-weight: 600;">
                <i class="fas fa-satellite-dish me-2 text-accent"></i>ประวัติการแจ้งเรื่องล่าสุด
            </h3>
            <div id="complaintList">
                <div class="text-center py-5 opacity-50 italic">กำลังโหลดข้อมูลจากฐานข้อมูล...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsBzUXKm_421QMAj2UG8IZYDiFLgc8vfw",
            authDomain: "student-council-nby-68.firebaseapp.com",
            projectId: "student-council-nby-68",
            storageBucket: "student-council-nby-68.firebasestorage.app",
            messagingSenderId: "198592356446",
            appId: "1:198592356446:web:c8de1a525606b10e8254cf",
            measurementId: "G-DW5W1B6NC3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const btnSubmit = document.getElementById('btnSubmit');
        const detailInput = document.getElementById('detail');
        const complaintList = document.getElementById('complaintList');

        // ฟังก์ชันส่งข้อมูล
        btnSubmit.addEventListener('click', async () => {
            const detail = detailInput.value.trim();

            if(!detail) {
                alert("กรุณาอธิบายปัญหาที่ท่านพบ");
                return;
            }

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = "กำลังส่งข้อมูล...";

            try {
                await addDoc(collection(db, "complaints"), {
                    detail: detail,
                    status: "ยังไม่ได้แก้ไข", // สถานะเริ่มต้น
                    timestamp: serverTimestamp()
                });
                detailInput.value = "";
                alert("ส่งเรื่องเรียบร้อยแล้ว ขอบคุณที่ร่วมพัฒนาโรงเรียนของเรา");
            } catch (e) {
                alert("เกิดข้อผิดพลาด กรุณาลองใหม่");
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="fas fa-paper-plane me-2"></i>ส่งข้อมูลให้สภานักเรียน';
            }
        });

        // ฟังก์ชันกำหนด Class ของ Status
        const getStatusClass = (status) => {
            if(status === "กำลังดำเนินการ") return "status-doing";
            if(status === "แก้ไขแล้ว") return "status-done";
            if(status === "ไม่สามารถทำได้") return "status-cancel";
            return "status-none";
        };

        // ดึงข้อมูล Real-time
        const q = query(collection(db, "complaints"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            complaintList.innerHTML = "";
            if(snapshot.empty) {
                complaintList.innerHTML = '<div class="text-center py-4 opacity-50">ยังไม่มีประวัติการแจ้งปัญหา</div>';
                return;
            }
            snapshot.forEach((doc) => {
                const data = doc.data();
                const date = data.timestamp ? data.timestamp.toDate().toLocaleString('th-TH') : 'กำลังส่ง...';
                const status = data.status || "ยังไม่ได้แก้ไข";
                
                const card = `
                    <div class="complaint-item">
                        <span class="status-badge ${getStatusClass(status)}">${status}</span>
                        <div class="complaint-text">${data.detail}</div>
                        <div class="complaint-meta">
                            <span><i class="far fa-calendar-alt me-1"></i> ${date}</span>
                            <span class="opacity-50">ID: ${doc.id.substring(0,6)}</span>
                        </div>
                    </div>
                `;
                complaintList.innerHTML += card;
            });
        });

        // Create Background Stars
        const stars = document.getElementById('stars-container');
        for (let i = 0; i < 80; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            const size = Math.random() * 2 + 1;
            star.style.width = size + 'px';
            star.style.height = size + 'px';
            star.style.top = Math.random() * 100 + '%';
            star.style.left = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 5 + 's';
            stars.appendChild(star);
        }
    </script>
</body>
</html>