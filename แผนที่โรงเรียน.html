<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>N.B.Y. Stellar 3D Campus</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.4);
            --glass: rgba(15, 23, 42, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --edge: 20px;
            --safe-bottom: calc(var(--edge) + env(safe-area-inset-bottom, 0px));
        }

        body {
            margin: 0; padding: 0; overflow: hidden;
            background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
            font-family: 'Kanit', sans-serif;
            touch-action: none; color: white;
        }

        /* --- Info Card --- */
        #info-card {
            position: absolute; 
            top: var(--edge); left: 50%; 
            transform: translateX(-50%) translateY(-20px);
            background: var(--glass); 
            border: 1px solid var(--border);
            padding: 12px 25px; border-radius: 100px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 20px var(--accent-glow);
            transition: 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 100; opacity: 0; pointer-events: none;
            border-bottom: 2px solid var(--accent);
        }
        #info-card.active { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* --- Controls --- */
        .zoom-controls {
            position: absolute; right: var(--edge); bottom: var(--safe-bottom);
            display: flex; flex-direction: column; gap: 12px; z-index: 101;
        }

        .nav-controls {
            position: absolute; left: var(--edge); bottom: var(--safe-bottom); z-index: 101;
        }

        .action-btn {
            width: 55px; height: 55px; background: var(--glass);
            border: 1px solid var(--border); border-radius: 20px;
            color: white; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .action-btn:active { transform: scale(0.9); background: var(--accent); color: #000; }
        
        .nav-toggle { background: var(--accent); color: #000; border: none; width: 65px; height: 65px; border-radius: 24px; font-size: 24px; }
        .nav-toggle.active { background: #ef4444; color: white; transform: rotate(45deg); }

        /* --- Menu --- */
        #nav-menu {
            position: absolute; 
            bottom: calc(var(--safe-bottom) + 85px); 
            left: var(--edge);
            width: 320px; max-width: calc(100% - 40px);
            background: var(--glass);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--border); border-radius: 32px; padding: 24px;
            transform: translateY(40px) scale(0.95); opacity: 0; pointer-events: none;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 90; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }
        #nav-menu.active { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }

        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 15px; }
        .tab-btn {
            flex: 1; padding: 10px; background: transparent; border: none; border-radius: 10px;
            color: #94a3b8; font-size: 0.85rem; cursor: pointer; transition: 0.3s;
        }
        .tab-btn.active { background: var(--accent); color: #000; font-weight: 600; box-shadow: 0 4px 15px var(--accent-glow); }

        .location-list {
            max-height: 40vh; overflow-y: auto; display: none;
            flex-direction: column; gap: 8px; padding-right: 10px;
        }
        .location-list.active { display: flex; }
        
        .loc-item {
            padding: 14px 18px; background: rgba(255,255,255,0.03);
            border-radius: 18px; cursor: pointer; border: 1px solid transparent;
            transition: 0.3s; display: flex; align-items: center; gap: 15px;
        }
        .loc-item:hover { background: rgba(56, 189, 248, 0.1); border-color: var(--accent); transform: translateX(5px); }
        .loc-item i { color: var(--accent); font-size: 1.1rem; filter: drop-shadow(0 0 8px var(--accent)); width: 20px; text-align: center; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    </style>
</head>
<body>
    <script src="All/กำลังโหลด.js"></script>
    <script src="All/ย้อนกลับ.js"></script>
    <script src="All/พื้นหลัง.js"></script>

    <div class="nav-controls">
        <button id="btn-toggle" class="action-btn nav-toggle" onclick="toggleMenu()">
            <i class="fas fa-map-marked-alt"></i>
        </button>
    </div>

    <div class="zoom-controls">
        <button id="btn-in" class="action-btn"><i class="fas fa-plus"></i></button>
        <button id="btn-out" class="action-btn"><i class="fas fa-minus"></i></button>
    </div>

    <div id="nav-menu">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('buildings')">อาคารเรียน</button>
            <button class="tab-btn" onclick="switchTab('zones')">โซนพื้นที่</button>
        </div>
        <div id="buildings" class="location-list active">
            <div class="loc-item" onclick="flyTo('หน้าเสาธง')"><i class="fas fa-flag"></i> หน้าเสาธง</div>
            <div class="loc-item" onclick="flyTo('หอประชุม')"><i class="fas fa-landmark"></i> หอประชุม</div>
            <div class="loc-item" onclick="flyTo('ศาลากรีฑา')"><i class="fas fa-medal"></i> ศาลากรีฑา</div>
            <div class="loc-item" onclick="flyTo('สนามฟุตบอล')"><i class="fas fa-futbol"></i> สนามฟุตบอล</div>
            <div class="loc-item" onclick="flyTo('อาคาร1')"><i class="fas fa-school"></i> อาคาร 1</div>
            <div class="loc-item" onclick="flyTo('อาคาร2')"><i class="fas fa-school"></i> อาคาร 2</div>
            <div class="loc-item" onclick="flyTo('อาคาร3')"><i class="fas fa-school"></i> อาคาร 3</div>
            <div class="loc-item" onclick="flyTo('โต๊ะปิงปอง')"><i class="fas fa-table-tennis-paddle-ball"></i> โต๊ะปิงปอง</div>
            <div class="loc-item" onclick="flyTo('โรงจอดรถ1')"><i class="fas fa-motorcycle"></i> โรงจอดรถ 1</div>
            <div class="loc-item" onclick="flyTo('โรงจอดรถ2')"><i class="fas fa-car"></i> โรงจอดรถ 2</div>
            <div class="loc-item" onclick="flyTo('โรงอาหาร')"><i class="fas fa-utensils"></i> โรงอาหาร</div>
            <div class="loc-item" onclick="flyTo('ห้องน้ำหญิง')"><i class="fas fa-venus"></i> ห้องน้ำหญิง</div>
            <div class="loc-item" onclick="flyTo('ห้องน้ำชาย')"><i class="fas fa-mars"></i> ห้องน้ำชาย</div>
            <div class="loc-item" onclick="flyTo('ชอป')"><i class="fas fa-tools"></i> ชอปสายอาชีพ</div>
            <div class="loc-item" onclick="flyTo('ศาลาน้ำดื่ม')"><i class="fas fa-tint"></i> ศาลาน้ำดื่ม</div>
            <div class="loc-item" onclick="flyTo('หอนอนหญิง')"><i class="fas fa-female"></i> หอนอนหญิง</div>
            <div class="loc-item" onclick="flyTo('หอนอนชาย')"><i class="fas fa-male"></i> หอนอนชาย</div>
            <div class="loc-item" onclick="resetHighlight(true)" style="margin-top:10px; color:#ef4444; justify-content:center; border: 1px dashed rgba(239, 68, 68, 0.4);"><i class="fas fa-redo"></i> รีเซ็ตมุมมอง</div>
        </div>
        <div id="zones" class="location-list">
            <div class="loc-item" onclick="flyTo('หอนอนชาย')"><i class="fas fa-bed"></i> เขตหอพัก</div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let scene, camera, renderer, controls, model;
        let zoomDir = 0, currentZoomSpeed = 0;
        let lastHighlightedObject = null;
        let originalMaterials = new Map();
        let initialCameraPos = new THREE.Vector3();
        let initialTargetPos = new THREE.Vector3();

        init();

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 1.2); scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1.5); sun.position.set(100, 300, 100); scene.add(sun);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = false;

            const loader = new GLTFLoader();
            loader.load('school_map.glb', (gltf) => {
                model = gltf.scene;
                scene.add(model);
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                initialTargetPos.copy(center);
                initialCameraPos.set(center.x + 500, center.y + 500, center.z + 500);
                controls.target.copy(initialTargetPos);
                camera.position.copy(initialCameraPos);
                animate();
            });

            setupZoomEvents();
            window.addEventListener('resize', onWindowResize);
        }

        window.flyTo = (objectName) => {
            const targetObj = model.getObjectByName(objectName);
            if (!targetObj) return;

            resetHighlight(false);
            lastHighlightedObject = targetObj;
            targetObj.traverse((child) => {
                if (child.isMesh) {
                    originalMaterials.set(child, child.material);
                    child.material = new THREE.MeshStandardMaterial({ color: 0x38bdf8, emissive: 0x38bdf8, emissiveIntensity: 0.5, transparent: true, opacity: 0.8 });
                }
            });

            document.getElementById('target-name').innerText = objectName;
            document.getElementById('info-card').classList.add('active');

            const targetPos = new THREE.Vector3();
            targetObj.getWorldPosition(targetPos);

            // --- หัวใจสำคัญ: ระบบ Padding 20% ---
            const box = new THREE.Box3().setFromObject(targetObj);
            const size = box.getSize(new THREE.Vector3()).length();
            // ถอยห่าง 2.5 เท่าของขนาดวัตถุ เพื่อให้เหลือพื้นที่ว่างรอบๆ 20-30%
            const distance = Math.max(size * 2.5, 180); 

            // ปรับมุมมองเยื้องด้านบนเล็กน้อยเพื่อให้ดูสวย (Cinematic Look)
            gsap.to(camera.position, {
                x: targetPos.x + distance, y: targetPos.y + distance, z: targetPos.z + distance,
                duration: 2, ease: "expo.out", onUpdate: () => controls.update()
            });

            gsap.to(controls.target, {
                x: targetPos.x, y: targetPos.y, z: targetPos.z,
                duration: 2, ease: "expo.out"
            });

            if(window.innerWidth < 768) toggleMenu();
        };

        window.toggleMenu = () => {
            document.getElementById('nav-menu').classList.toggle('active');
            document.getElementById('btn-toggle').classList.toggle('active');
        };

        window.resetHighlight = (moveCamera = true) => {
            if (lastHighlightedObject) {
                lastHighlightedObject.traverse(c => { if(c.isMesh && originalMaterials.has(c)) c.material = originalMaterials.get(c); });
                originalMaterials.clear(); lastHighlightedObject = null;
                document.getElementById('info-card').classList.remove('active');
            }
            if (moveCamera) {
                gsap.to(controls.target, { x: initialTargetPos.x, y: initialTargetPos.y, z: initialTargetPos.z, duration: 1.5, ease: "expo.out" });
                gsap.to(camera.position, { x: initialCameraPos.x, y: initialCameraPos.y, z: initialCameraPos.z, duration: 1.5, ease: "expo.out", onUpdate: () => controls.update() });
            }
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.location-list').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        };

        function setupZoomEvents() {
            const setup = (id, dir) => {
                const btn = document.getElementById(id);
                btn.onpointerdown = (e) => { btn.setPointerCapture(e.pointerId); zoomDir = dir; };
                btn.onpointerup = () => zoomDir = 0;
            };
            setup("btn-in", -1); setup("btn-out", 1);
        }

        function updateZoom() {
            currentZoomSpeed += (zoomDir * 10.0 - currentZoomSpeed) * 0.15;
            if (Math.abs(currentZoomSpeed) > 0.01) {
                const dir = new THREE.Vector3(); camera.getWorldDirection(dir);
                camera.position.addScaledVector(dir, -currentZoomSpeed);
                controls.update();
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            updateZoom();
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>


